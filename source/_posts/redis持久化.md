---
title: redis持久化
date: 2021-12-27 22:40:53
tags: redis持久化
categories: redis
---

> redis 持久化主要有2种方式：RDB 和AOF

# RDB快照

## 什么是RDB快照

- rdb就是快照，是redis默认的持久化方式，就是把所有的数据持久化到磁盘，隔一段时间持久化一次到 dump.rdb 的二进制文件中，在服务器重启后只需要把文件中的数据恢复即可。 
- 你可以对 Redis 进行设置， 让它在“ N 秒内数据集至少有 M 个改动”这一条件被满足时， 自动保存一次数据集。 比如说， `save 60 1000`会让 Redis 在满足“ 60 秒内有至少有 1000 个键被改动”这一条件时， 自动保存一次数据集

## RDB 文件的创建

> 有两种方式：手动触发和自动触发

### 手动触发

- save命令会阻塞当前Redis服务器，直到RDB过程完成为止。在服务器进程阻塞期间，服务器不能处理任何命令请求。因此，当save命令正在执行时，客户端发送的所有命令都会被拒绝，知道save命令执行完毕。（不建议使用）
- bgsave 命令会fork出一个子进程(而不是线程)，由子进程进行RDB文件创建，而父进程继续处理命令。

> 进入redis客户端执行命令**save**或**bgsave**可以生成dump.rdb文件， 每次命令执行都会将所有redis内存快照到一个新的rdb文件里，并覆盖原有rdb快照文件。 

### 自动触发

redis通过配置文件进行配置，redis可以通过设置服务器配置的save选项，服务器每隔一段时间自动执行一次bgsave命令。

### 优缺点

**优点：**

- 适合大规模的数据恢复，恢复速度快！
- 体积小，相较于aof他只是保存了结果，不需要保存每一次命令操作。

**缺点：**

- 数据需要一定的时间间隔进程操作！ 如果 Redis 因为某些原因而造成故障停机， 那么服务器将丢失最近写入、且仍未保存到快照中的那些数据就没有了。



# AOF

- 以独立日志的方式记录每次写命令，每当 Redis 执行一个改变数据集的命令时（比如 SET）， 这个命令就会被追加到 appendonly.aof文 件的末尾，并在 Redis 重启时在重新执行 AOF 文件中的命令以达到恢复数据的目的。
- AOF 的主要作用是解决数据持久化的实时性。
- 你可以通过修改配置文件来打开 AOF 功能：  `appendonly yes `
- 你可以配置 Redis 多久才将数据 fsync 到磁盘一次。 
  - **appendfsync always**：每次有新命令追加到 AOF 文件时就执行一次 fsync ，非常慢，也非常安全。
  - **appendfsync everysec**：每秒 fsync 一次，足够快（和使用 RDB 持久化差不多），并且在 故障时只会丢失 1 秒钟的数据。
  - **appendfsync no**：：从不 fsync ，将数据交给操作系统来处理。更快，也更不安全的选择。 推荐（并且也是默认）的措施为每秒 fsync 一次， 这种 fsync 策略可以兼顾速度和安全性。 

## AOF 重写

- AOF文件里可能有太多没用指令，比如3次递增readcount, 重写后直接会变成readcount:3，AOF会定期根据**内存的最新数据**生成aof文件

- 进入redis客户端执行命令**bgrewriteaof**重写AOF 

- AOF重写redis会fork出一个子进程去做，不会对redis正常命令处理有太多影响
- 如下两个配置可以控制AOF自动重写频率 
  - auto-aof-rewrite-min-size 64mb //aof文件至少要达到64M才会自动重写，文件太小恢复速度本来就很快，重写的意义不大
  - auto-aof-rewrite-percentage 100 //aof文件自上一次重写后文件大小增长了100%则再次触发重写

### 优缺点

**优点**：

- 每一次修改都同步，文件的完整性会更加好！

**缺点：**

- 相对于数据文件来说，aof远远大于 rdb，修复的速度也比 rdb慢！

  

# **Redis 4.0 混合持久化** 

> 重启 Redis 时，我们很少使用 RDB来恢复内存状态，因为会丢失大量数据。我们通常使用 AOF 日志存放，但是存放 AOF 日志性能相对 RDB来说要慢很多，这样在 Redis 实例很大的情况下，启动需要花费很长的时间。
>
> Redis 4.0 为了解决这个问题，带来了一个新的持久化选项——混合持久化。 通过配置 ` aof-use-rdb-preamble yes`可以开启混合持久化。   

## 混合持久化流程

- 如果开启了混合持久化。**AOF在重写时**，不再是单纯将内存数据转换为命令写入AOF文件，而是根据aof命令重写**这一刻之前**的内存做RDB快照处理，并且将RDB快照内容和**增量的**AOF修改内存数据的命令存在一起，都写入新的AOF文件。
- 新的文件一开始不叫appendonly.aof，等到重写完新的AOF文件才会进行改名，原子的覆盖原有的AOF文件，完成新旧两个AOF文件的替换。
-  于是在 Redis 重启的时候，可以先加载 RDB 的内容，然后再加载增量 AOF 日志就可以完全替代之前的 AOF 全量文件的加载，因此重启效率大幅得到提升。 

## 混合持久化AOF文件结构

<img src="https://tva1.sinaimg.cn/large/008i3skNly1gxtx3e8tbhj30r40i23zd.jpg" style="zoom:50%;" /><img src="https://tva1.sinaimg.cn/large/008i3skNly1gxtx4ka5e8j31ey0q6myv.jpg" style="zoom: 33%;" />

 
